name: iOS Build & Test

on:
  push:
    branches: [ main, test-ios-deploy ]
  pull_request:
    branches: [ main, test-ios-deploy ]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.27.1'
        channel: 'stable'
    
    - name: Select Xcode 15.0.1
      run: sudo xcode-select -s /Applications/Xcode_15.0.1.app/Contents/Developer
    
    - name: Disable Flutter analytics
      run: flutter config --no-analytics
    
    # ===== FIREBASE CONFIG VERIFICATION =====
    - name: Verify Firebase config
      run: |
        echo "=== Verifying Firebase config ==="
        if [ -f ios/Runner/GoogleService-Info.plist ]; then
          echo "âœ… Firebase config found!"
          echo "Bundle ID: $(grep -A1 'BUNDLE_ID' ios/Runner/GoogleService-Info.plist | tail -1 | sed 's/.*<string>\(.*\)<\/string>.*/\1/')"
          echo "Project ID: $(grep -A1 'PROJECT_ID' ios/Runner/GoogleService-Info.plist | tail -1 | sed 's/.*<string>\(.*\)<\/string>.*/\1/')"
          echo "File size: $(wc -c < ios/Runner/GoogleService-Info.plist) bytes"
        else
          echo "âŒ Firebase config missing!"
          exit 1
        fi
    
    - name: Update iOS deployment target
      run: |
        sed -i '' 's/IPHONEOS_DEPLOYMENT_TARGET = [0-9]*\.[0-9]*/IPHONEOS_DEPLOYMENT_TARGET = 13.0/g' ios/Runner.xcodeproj/project.pbxproj
        if [ -f ios/Podfile ]; then
          sed -i '' "s/platform :ios, '[0-9]*\.[0-9]*'/platform :ios, '13.0'/g" ios/Podfile
        fi
    
    # ===== OPTIMISATION BUILD =====
    - name: Cache Flutter dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.pub-cache
          ios/Pods
        key: ${{ runner.os }}-flutter-${{ hashFiles('pubspec.yaml') }}-${{ hashFiles('ios/Podfile.lock') }}
        restore-keys: |
          ${{ runner.os }}-flutter-
    
    - name: Install dependencies
      run: flutter pub get
    
    - name: Generate code with build_runner
      run: dart run build_runner build --delete-conflicting-outputs
    
    # ===== BUILDS OPTIMISÃ‰S =====
    - name: Build iOS for Simulator (Debug + Logs)
      run: flutter build ios --simulator --debug
    
    - name: Test on iOS Simulator with Firebase
      run: |
        echo "=== Testing Firebase initialization ==="
        
        # Lance le simulateur iPhone 15
        xcrun simctl boot "iPhone 15" || echo "Simulator already running"
        sleep 10
        
        # Installe l'app
        xcrun simctl install booted build/ios/iphonesimulator/Runner.app
        
        # Logs spÃ©cifiques Firebase + Flutter
        xcrun simctl spawn booted log stream \
          --predicate 'process == "Runner" AND (message CONTAINS "Firebase" OR message CONTAINS "flutter" OR message CONTAINS "GoogleService")' \
          --info --debug > firebase_logs.txt &
        LOG_PID=$!
        
        # Lance l'app
        echo "ðŸš€ Launching app..."
        xcrun simctl launch booted com.thomassamp.prescriptionManager
        
        # Attendre Firebase init
        echo "â³ Waiting for Firebase initialization..."
        sleep 30
        
        # ArrÃªter logs
        kill $LOG_PID || true
        
        # Afficher logs Firebase
        echo "=== FIREBASE LOGS ==="
        cat firebase_logs.txt | grep -i firebase || echo "No Firebase logs found"
        
        # Logs gÃ©nÃ©raux
        xcrun simctl spawn booted log stream \
          --predicate 'process == "Runner"' \
          --info --since '30s ago' > general_logs.txt &
        LOG_PID2=$!
        sleep 15
        kill $LOG_PID2 || true
        
        echo "=== GENERAL LOGS (last 50 lines) ==="
        tail -50 general_logs.txt
    
    - name: Build iOS for Device (Release)
      run: flutter build ios --no-codesign --release
    
    - name: Create optimized IPA
      run: |
        cd build/ios/iphoneos
        mkdir -p Payload
        cp -r Runner.app Payload/
        zip -r app-unsigned.ipa Payload/
        
        echo "âœ… IPA created: $(ls -lh app-unsigned.ipa | awk '{print $5}')"
    
    # ===== ARTIFACTS =====
    - name: Upload IPA
      uses: actions/upload-artifact@v4
      with:
        name: ios-app-unsigned
        path: build/ios/iphoneos/app-unsigned.ipa
    
    - name: Upload Firebase Logs
      uses: actions/upload-artifact@v4
      with:
        name: firebase-logs
        path: firebase_logs.txt
    
    - name: Upload General Logs
      uses: actions/upload-artifact@v4
      with:
        name: general-logs
        path: general_logs.txt
    
    # ===== RÃ‰SUMÃ‰ =====
    - name: Final Summary
      run: |
        echo "ðŸŽ‰ ===== BUILD COMPLETE ====="
        echo "âœ… Firebase config: VERIFIED"
        echo "âœ… Simulator test: COMPLETED"
        echo "âœ… Device build: SUCCESS"
        echo "âœ… IPA ready for installation"
        echo ""
        echo "ðŸ“± Your app with Firebase should now work perfectly!"